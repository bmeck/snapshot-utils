<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/bin/dominators.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/bmeck/snapshot-utils" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/HeapSnapshot.js~HeapSnapshot.html">HeapSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/SplitSnapshotProvider.js~SplitSnapshotProvider.html">SplitSnapshotProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseSnapshotStream">parseSnapshotStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EdgeResult">EdgeResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NodeResult">NodeResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WalkCallbacks">WalkCallbacks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Sample">Sample</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-parseSnapshotStreamCallbacks">parseSnapshotStreamCallbacks</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/bin/dominators.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {HeapSnapshot,SplitSnapshotProvider} from &quot;../&quot;;

// We are going to use stdin to read our snapshot
// pipe a snapshot in via: `node dump.js &lt;&quot;my.heapsnapshot&quot;`
const stream = process.stdin;

// This is used to parse the snapshot data.
// A provider is generally not used for analyzing the snapshot.
// It is an abstraction to allow saving/loading the snapshot to different
// location.
SplitSnapshotProvider.fromStream(stream, (err, provider) =&gt; {
	if (err) {
		console.error(err);
		process.exit(1);
	}
	// This gives us an API that can be used to analyze the snapshot.
	// Since snapshot data contains the structure of Nodes and Edges
	// the Node and Edge classes we obtain from this may be different
	// from different snapshots.
	const snapshot = new HeapSnapshot(provider);
	
	const path = [];
	
	let tree = null;
	const lookup = new Map();
	const $id = node =&gt; node.fields.id;
	function integrate(id) {
		if (tree == null) {
			tree = new DominatorTreeNode(null, id);
			lookup.set(id, tree);
			return;
		}
		let parent_id = path.length - 1;
		let node = new DominatorTreeNode(path[parent_id], id);
		lookup.set(id, node);
	}
	// we only ever need to reduce to immediate dominator,
	// but! me must adjust any current immediate dominator as well
	function reduce(id, max_path = path.length) {
		let subpath = path.slice(0, max_path);
		let dominator = lookup.get(id).parent;
		let adjusting = [id];
		while (lookup.has(dominator)) {
			let index = subpath.indexOf(dominator);
			if (index &gt;= 0) {
				for (const node_id of adjusting) {
					lookup.get(node_id).parent = dominator;
				}
				break;
			}
			adjusting.push(dominator);
			dominator = lookup.get(dominator).parent;
		}
	}
	
	// setup the walk
	const iter = snapshot.walk({
		// first time we encounter a node we need to add
		// the full path to the dominator tree
		onNodeOpen(node) {
			const id = $id(node);
			integrate(id);
			path.push(id);
		},
		// when we encounter a node we have already seen
		// we only need to reduce the dominator tree
		onNodeSkipped(node) {
			const id = $id(node);
			reduce(id);
		},
		onNodeClose(node) {
			path.pop(node);
		}
	});
	// perform the walk
	for (const _ of iter) {}
	
	// print our lovely data
	for (const node of lookup.values()) {
		let ret = `${node.id}`;
		let parent_id = node.parent;
		while (parent_id != null &amp;&amp; lookup.has(parent_id)) {
			ret += `-&gt;${parent_id}`;
			parent_id = lookup.get(parent_id).parent;
		}
		console.log(ret);
	}
});

class DominatorTreeNode {
	constructor(parent, id) {
		this.parent = parent;
		this.id = id;
	}
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
